<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maximum Power Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
        }
        table {
            border-collapse: collapse;
            margin: 20px 0;
            background: #252526;
        }
        th, td {
            border: 1px solid #3e3e42;
            padding: 8px 12px;
            text-align: right;
        }
        th {
            background: #2d2d30;
            color: #4ec9b0;
        }
        .close {
            background: #1e3a1e;
        }
        .far {
            background: #3a1e1e;
        }
        .info {
            margin: 20px 0;
            padding: 15px;
            background: #252526;
            border-left: 4px solid #4ec9b0;
        }
    </style>
</head>
<body>
    <h1>Maximum Power Curve Test</h1>
    <p>Testing against WinISD UMII18-22 in 330L sealed box</p>

    <div class="info">
        <strong>WinISD Reference Data:</strong><br>
        Volume: 330L, Qtc: 0.707, Fsc: 68.73Hz<br>
        Driver: Fs=22Hz, Qts=0.53, Vas=248.2L, Xmax=28mm, Pe=1200W
    </div>

    <div id="results"></div>

    <!-- Load library files -->
    <script src="models/Driver.js"></script>
    <script src="models/SealedBox.js"></script>
    <script src="calculators/ExcursionCalculator.js"></script>
    <script src="validation/winisd-reference.js"></script>

    <script>
        // Create UMII18-22 driver with 330L sealed box
        const umii18 = new Driver({
            fs: 22.0,
            qts: 0.530,
            qes: 0.670,
            qms: 2.530,
            vas: 248.2,
            re: 4.2,
            le: 1.15,
            xmax: 28,
            sd: 1184,
            pe: 1200
        });

        const box = new SealedBox(umii18, 330);

        console.log('Box parameters:');
        console.log('Qtc:', box.qtc.toFixed(3));
        console.log('Fc:', box.fc.toFixed(1), 'Hz');
        console.log('F3:', box.f3.toFixed(1), 'Hz');

        // Generate maximum power curve
        const frequencies = [10, 20, 30, 40, 50, 100, 200];
        const results = [];

        for (const freq of frequencies) {
            const calculated = ExcursionCalculator.calculateMaxPower(box, freq);

            // Find WinISD reference if available
            const winisd = WinISDReference.umii18_sealed_butterworth.maxPowerCurve.find(
                p => p.frequency === freq
            );

            results.push({
                frequency: freq,
                calculated: calculated.maxPower,
                winisd: winisd ? winisd.maxPower : null,
                limitingFactor: calculated.limitingFactor,
                displacement: calculated.displacement.toFixed(1)
            });
        }

        // Display results
        let html = '<table>';
        html += '<tr><th>Freq (Hz)</th><th>Calculated (W)</th><th>WinISD (W)</th><th>Diff</th><th>Limiting</th><th>Disp (mm)</th></tr>';

        for (const r of results) {
            const diff = r.winisd ? ((r.calculated - r.winisd) / r.winisd * 100).toFixed(0) + '%' : '-';
            const diffClass = r.winisd ? (Math.abs(r.calculated - r.winisd) < 100 ? 'close' : 'far') : '';

            html += `<tr class="${diffClass}">`;
            html += `<td>${r.frequency}</td>`;
            html += `<td>${r.calculated}</td>`;
            html += `<td>${r.winisd || '-'}</td>`;
            html += `<td>${diff}</td>`;
            html += `<td>${r.limitingFactor}</td>`;
            html += `<td>${r.displacement}</td>`;
            html += '</tr>';
        }

        html += '</table>';

        html += '<div class="info">';
        html += '<strong>Test Summary:</strong><br>';
        html += 'Green rows: Within 100W of WinISD<br>';
        html += 'Red rows: More than 100W difference<br>';
        html += 'This is a FIRST implementation - formulas will be refined to match WinISD exactly';
        html += '</div>';

        document.getElementById('results').innerHTML = html;

        // Also test power safety check
        console.log('\\n=== Power Safety Checks ===');
        const safetyTests = [
            { power: 200, desc: '200W (should be safe)' },
            { power: 500, desc: '500W (marginal at low freq)' },
            { power: 1000, desc: '1000W (excursion limited below 50Hz)' }
        ];

        for (const test of safetyTests) {
            const safety = ExcursionCalculator.checkPowerSafety(box, test.power);
            console.log(`\\n${test.desc}:`);
            console.log('  Safe:', safety.safe ? 'YES' : 'NO');
            if (safety.warnings.length > 0) {
                console.log('  Warnings:');
                safety.warnings.forEach(w => {
                    console.log(`    ${w.frequency}Hz: ${w.message}`);
                });
            }
        }
    </script>
</body>
</html>
