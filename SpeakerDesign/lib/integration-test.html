<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Smoke Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .pass { color: #4ec9b0; }
        .fail { color: #f48771; }
        pre { background: #252526; padding: 10px; border-left: 3px solid #0e639c; }
    </style>
</head>
<body>
    <h1>Integration Smoke Test</h1>
    <p>Testing library ‚Üí adapter ‚Üí UI compatibility</p>
    <div id="results"></div>

    <!-- Load dependencies -->
    <script src="../js/constants.js"></script>

    <!-- Load library -->
    <script src="models/Driver.js"></script>
    <script src="models/SealedBox.js"></script>
    <script src="models/PortedBox.js"></script>
    <script src="calculators/AlignmentCalculator.js"></script>
    <script src="calculators/SPLCalculator.js"></script>
    <script src="SpeakerPhysics.js"></script>

    <!-- Load adapter -->
    <script src="../js/calculations-v2.js"></script>

    <script>
        const results = [];

        function test(name, fn) {
            try {
                fn();
                results.push({ name, passed: true });
                console.log(`‚úì ${name}`);
            } catch (error) {
                results.push({ name, passed: false, error: error.message });
                console.error(`‚úó ${name}:`, error);
            }
        }

        function assertEquals(actual, expected, message) {
            if (Math.abs(actual - expected) > 0.1) {
                throw new Error(`${message}: expected ${expected}, got ${actual}`);
            }
        }

        // Test 1: Library loads correctly
        test('Library loads', () => {
            if (typeof Driver === 'undefined') throw new Error('Driver not loaded');
            if (typeof SealedBox === 'undefined') throw new Error('SealedBox not loaded');
            if (typeof PortedBox === 'undefined') throw new Error('PortedBox not loaded');
            if (typeof SpeakerPhysics === 'undefined') throw new Error('SpeakerPhysics not loaded');
        });

        // Test 2: Adapter loads correctly
        test('Adapter loads', () => {
            if (typeof SpeakerCalculations === 'undefined') {
                throw new Error('SpeakerCalculations not loaded');
            }
        });

        // Test 3: Constants available
        test('Constants available', () => {
            if (typeof Constants === 'undefined') throw new Error('Constants not loaded');
            if (!Constants.ALIGNMENTS) throw new Error('ALIGNMENTS not defined');
            if (!Constants.PORT) throw new Error('PORT not defined');
        });

        // Test 4: Driver creation via library
        test('Create driver (library)', () => {
            const driver = new Driver({ fs: 27.4, qts: 0.39, vas: 185 });
            if (!driver.isValid()) throw new Error('Driver invalid');
            if (!driver.canCalculateSealed()) throw new Error('Cannot calculate sealed');
        });

        // Test 5: Sealed alignment via library
        test('Sealed alignment (library)', () => {
            const driver = new Driver({ fs: 27.4, qts: 0.39, vas: 185 });
            const alignments = AlignmentCalculator.calculateSealedAlignments(driver);
            if (alignments.length === 0) throw new Error('No alignments found');

            const butterworth = alignments.find(a => a.name.includes('Butterworth'));
            if (!butterworth) throw new Error('Butterworth not found');

            // Check box volume is reasonable
            if (butterworth.vb < 90 || butterworth.vb > 110) {
                throw new Error(`Box volume out of range: ${butterworth.vb}L`);
            }
        });

        // Test 6: Sealed calculation via adapter (UI compatibility)
        test('Sealed via adapter', () => {
            const params = { fs: 27.4, qts: 0.39, vas: 185 };
            const results = SpeakerCalculations.calculateSealed(params);

            if (!results || results.length === 0) {
                throw new Error('No results from adapter');
            }

            const butterworth = results.find(r => r.alignment.includes('Butterworth'));
            if (!butterworth) throw new Error('Butterworth not found');

            const vb = parseFloat(butterworth.vb);
            if (vb < 90 || vb > 110) {
                throw new Error(`Box volume out of range: ${vb}L`);
            }
        });

        // Test 7: Ported calculation via adapter
        test('Ported via adapter', () => {
            const params = { fs: 34.3, qts: 0.35, vas: 201, sd: 860, xmax: 8.5 };
            const results = SpeakerCalculations.calculatePorted(params);

            if (!results || results.length === 0) {
                throw new Error('No results from adapter');
            }

            const qb3 = results.find(r => r.alignment.includes('QB3'));
            if (!qb3) throw new Error('QB3 not found');

            const vb = parseFloat(qb3.vb);
            if (vb < 100 || vb > 150) {
                throw new Error(`Box volume out of range: ${vb}L`);
            }

            if (!qb3.portLength) throw new Error('Port length not calculated');
        });

        // Test 8: All alignments via adapter
        test('All alignments via adapter', () => {
            const params = { fs: 27.4, qts: 0.39, vas: 185, sd: 1160, xmax: 18, pe: 500, re: 3.5 };
            const sealed = SpeakerCalculations.calculateAllAlignments(params, 'sealed');
            const ported = SpeakerCalculations.calculateAllAlignments(params, 'ported');

            if (sealed.length === 0) throw new Error('No sealed alignments');
            if (ported.length === 0) throw new Error('No ported alignments');

            // Check sealed has frequency response
            if (!sealed[0].frequencies || sealed[0].frequencies.length === 0) {
                throw new Error('No frequency data in sealed');
            }
            if (!sealed[0].spl || sealed[0].spl.length === 0) {
                throw new Error('No SPL data in sealed');
            }
        });

        // Test 9: Limiting factors via adapter
        test('Limiting factors via adapter', () => {
            const params = { fs: 27.4, qts: 0.39, vas: 185, sd: 1160, xmax: 18, pe: 500, re: 3.5 };
            const limits = SpeakerCalculations.calculateLimitingFactors(params, 'sealed', 100, null, 500, 25);

            if (!limits) throw new Error('No limits returned');
            if (typeof limits.systemSPL !== 'number') throw new Error('systemSPL not a number');
            if (!limits.limitingFactor) throw new Error('limitingFactor not set');

            // SPL should be reasonable at 500W
            if (limits.systemSPL < 90 || limits.systemSPL > 120) {
                throw new Error(`SPL out of range: ${limits.systemSPL.toFixed(1)} dB`);
            }
        });

        // Test 10: Port velocity calculation
        test('Port velocity calculation', () => {
            const velocity = SpeakerCalculations.calculatePortVelocity(860, 8.5, 34.3, 10);

            if (typeof velocity !== 'number') throw new Error('Velocity not a number');
            if (velocity < 10 || velocity > 25) {
                throw new Error(`Velocity out of range: ${velocity.toFixed(1)} m/s`);
            }
        });

        // Display results
        const passed = results.filter(r => r.passed).length;
        const total = results.length;
        const allPassed = passed === total;

        let html = `<h2>${allPassed ? '‚úì' : '‚úó'} ${passed}/${total} tests passed</h2>`;

        for (const result of results) {
            const className = result.passed ? 'pass' : 'fail';
            const icon = result.passed ? '‚úì' : '‚úó';
            html += `<div class="${className}">${icon} ${result.name}`;
            if (result.error) {
                html += `<br>&nbsp;&nbsp;&nbsp;Error: ${result.error}`;
            }
            html += `</div>`;
        }

        if (allPassed) {
            html += `<h3 class="pass">üéâ Integration successful!</h3>`;
            html += `<p>Library ‚Üí Adapter ‚Üí UI chain working correctly.</p>`;
            html += `<p>Safe to use in production.</p>`;
        } else {
            html += `<h3 class="fail">‚ö†Ô∏è Integration issues found</h3>`;
            html += `<p>Check console for details.</p>`;
        }

        document.getElementById('results').innerHTML = html;
    </script>
</body>
</html>
